{% extends "base.html" %}

{% block style %}
<title>{{ current_user.username }} - Profile</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-profile.css') }}">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
{% endblock %}


{% block main %}
<!-- self introduction part -->

<div class="container-fluid self-intro background-brown text-muted">
    <div class="row clearfix mt-5 mb-4">
        <div class="col-md-2 column">
        </div>
        <div class="col-md-2 column">
            <img alt="Profile Picture" src="https://robohash.org/{{ user.email }}" class="rounded-circle title-ava mx-5" />
        </div>
        <div class="col-md-5 column personal-details">
            <h3 class="text-left">
                {{ user.username }}
            </h3>
            <div>
                <i class="bi bi-fire"></i>
                <span>{{ user.credit }} points</span>
            </div>
            <!-- Scrollable area -->
            <div class="overflow-auto mt-4" style="max-height: 100px;">
                <p id="bio-text" class="text-left">
                    {% if user.bio %}
                    {{ user.bio }}
                    {% else %}
                    This user has not provided a bio yet...
                    {% endif %}
                </p>
            </div>
            <button id="edit-btn" class="btn btn-secondary bg-gradient text-white mt-2">Edit Bio</button>
            <form id="bio-form" method="post" action="/personal-profile" style="display: none;">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <!-- Textarea with current bio content -->
                <textarea id="new-bio" name="new_bio" class="form-control mt-4" rows="3" placeholder="Enter new bio"></textarea>
                <!-- Submit button -->
                <button type="submit" id="submit-btn" class="btn btn-secondary bg-gradient text-white mt-3">Submit</button>
            </form>
            
            <script>
                document.getElementById('edit-btn').addEventListener('click', function() {
                    var bioText = document.getElementById('bio-text');
                    var bioForm = document.getElementById('bio-form');
                    var submitBtn = document.getElementById('submit-btn');
                    var editBtn = document.getElementById('edit-btn');
                    var newBioTextarea = document.getElementById('new-bio');
                    
                    if (bioForm.style.display === 'none') {
                        // Switch to edit mode
                        bioForm.style.display = 'block';
                        bioText.style.display = 'none';
                        submitBtn.textContent = 'Submit'; // Change button text to 'Submit'
                        editBtn.style.display = 'none'; // Hide the 'Edit' button
                        
                        // Copy current bio content to textarea
                        newBioTextarea.value = bioText.textContent.trim();
                    } else {
                        // Switch to view mode
                        bioForm.style.display = 'none';
                        bioText.style.display = 'block';
                        submitBtn.textContent = 'Edit'; // Change button text back to 'Edit'
                        editBtn.style.display = 'block'; // Show the 'Edit' button again
                    }
                });
            </script>
            
            
            
            
            

        </div>
        <div class="col-md-3 column">
        </div>
    </div>
</div>
<!-- Explanation
Image Path: The default filter is used to provide a fallback image if user.profile_picture_url is undefined or empty.
Date Formatting: The date filter formats the user's join date. Make sure you have installed and configured the Jinja2 date filter in your Flask app.
Badge Rendering: Assuming user.badges contains a list of badges a user has earned, they are rendered using a loop as Bootstrap badges.
Biography Section: user.bio is included and the default filter provides a fallback text in case the field is empty. -->

<!-- navbar -->
<div class="container">
    <div class="row clearfix">
        <!-- Sidebar navigation column -->
        <div class="personal-profile-nav col-md-3 column">
            <ul class="nav flex-column mt-4 mx-5">
                <!-- Navigation item for Posts -->
                <li class="nav-item mb-1">
                    <a class="nav-link text-secondary hover-orange" href="/personal-profile">
                        <!-- Placeholder SVG icon for Posts -->
                        <i class="bi bi-chat"></i>
                        <span class="Button-label">Posts</span>
                        <!-- Dynamically displays the count of posts
                        <span class="Button-badge"></span> -->
                    </a>
                </li>
                <!-- Navigation item for Discussions -->
                <li class="nav-item mb-1">
                    <a class="nav-link text-secondary hover-orange" href="?show=comments">
                        <!-- Placeholder SVG icon for Discussions -->
                        <i class="bi bi-list-ul"></i>
                        <span class="Button-label">Discussions</span>
                        <!-- Dynamically displays the count of discussions
                        <span class="Button-badge">{{ discussion_count }}</span> -->
                    </a>
                </li>
            </ul>
        </div>
 <!-- navbar explanation
List of Variables to be Passed from the Backend
post_count:
Description: Represents the total number of posts available or created by the user. This variable is used to display a badge next to the "Posts" link in the navigation bar.
Type: Integer
discussion_count:
Description: Indicates the total number of discussions initiated or participated in by the user. This count is displayed next to the "Discussions" link.
Type: Integer
like_count:
Description: Shows the total number of likes received by the user across their posts or interactions. This number is shown next to the "Likes" link.
Type: Integer
vote_count:
Description: Reflects the total number of votes the user has cast or received in various polls or voting interactions on the platform. Displayed next to the "Votes" link.
Type: Integer
mention_count:
Description: Counts how many times the user has been mentioned across different posts or comments within the platform. This is shown next to the "Mentions" link.
Type: Integer 
-->


        <!-- post-list -->
        <div class="col-md-9 column mt-3">
            <!-- <div class="row clearfix">
                <div class="col-md-10 column row"> -->
                    <!-- Loop through each post in the list of posts -->
                    <!-- {# for post in posts #}
                    <div class="col-md-11 column row clearfix list-margin border-0 border-bottom">
                        <p class="text-secondary">{# post.title #}</p>
                        <div class="col-md-1 column">
                            <img alt="Profile Picture" src='https://robohash.org/{# post.author.email #}' class="rounded-circle" style="width: 50px; height: 50px;" />
                        </div>
                        <div class="col-md-11">
                            <ul class="list-inline list-style-none">
                                <li class="h6 list-inline-item list-style-none">{# post.author.username #}</li>
                                <li class="text-secondary list-inline-item"><span id="humanTimestamp_{# post.id #}"></span></li>
                                <li class="text-secondary list-inline-item">{# 'Edited' if post.edited else '' #}</li>
                            </ul>
                            <h5>
                                {# post.subtitle #}
                            </h5>
                            <p>
                                {# post.content #}
                            </p>
                            <div class="list-reply-margin">
                                <p> -->
                                    <!-- Example of interaction -->
                                    <!-- <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                                        fill="currentColor" class="bi bi-arrow-90deg-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4z" />
                                    </svg> 
                                </p>
                                <p>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                                        fill="currentColor" class="bi bi-arrow-90deg-left" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4z" />
                                    </svg> {# post.likes #} people like this.
                                </p>
                            </div>
                        </div>
                    </div>
                    {# endfor #}
                </div>
            </div> -->
            {% if mix %}
                <ul class="discussion-list list-unstyled">
                    {% for post, comments in mix.items() %}
                    {% for comment in comments %}
                    <li>
                        <div class="row clearfix">
                            <div class="col-md-10 column row clearfix">
                                <div class="col-md-1 column">
                                    <img alt="50x50" src='https://robohash.org/{{ post.author.email }}' class="rounded-circle"
                                        style="width: 50px; height: 50px;" />
                                </div>

                                <div class="col-md-11">
                                    <h5>
                                        <a href="{{ url_for('postDetails', post_id=post.id) }}#{{ comment.id }}" style="text-decoration: none; color: inherit;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='inherit'">{{ post.title }}</a>
                                    </h5>
                                    <p>
                                        <i class="bi bi-reply-fill"></i>
                                        <span>Replied to <b>{{ post.author.username }}</b></span>
                                    </p>
                                
                                    <p>{{ comment.body }}</p>
                               
                                </div>

                            </div>
                            <div class="col-md-2 column">
                                <div class="row clearfix">
                                    <div class="col-md-6 column category-tag">
                                        <span class="badge category-tag" data-category-id="{{ post.category.id }}">{{ post.category.name }}</span>
                                    </div>
                                    <div class="col-md-6 column text-secondary">
                                        <p>
                                            <i class="bi bi-chat-right-heart-fill"></i> 
                                            {{ post.comments.all()|length }}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-danger mt-5" style="text-align: right;">
                                    <button class="btn deleteBtn">
                                        &nbsp;
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                    {% endfor %}
                </ul>
            {% elif posts %}
            <ul class="discussion-list list-unstyled">
                {% for post in posts %}
                <li>
                    <div class="row clearfix">
                        <div class="col-md-10 column row clearfix">
                            <div class="col-md-1 column">
                                <img alt="50x50" src='https://robohash.org/{{ post.author.email }}' class="rounded-circle"
                                    style="width: 50px; height: 50px;" />
                            </div>

                            <div class="col-md-11">
                                <h5>
                                    <a href="{{ url_for('postDetails', post_id=post.id) }}" style="text-decoration: none; color: inherit;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='inherit'">{{ post.title }}</a>
                                </h5>
                                <p>
                                    <i class="bi bi-reply-fill"></i>
                                    Publish Date: <span id="humanTimestamp_{{ post.id }}"></span>
                                </p>
                                <p>
                                    {{ post.body }}
                                </p>
                            </div>

                        </div>
                        <div class="col-md-2 column">
                            <div class="row clearfix">
                                <div class="col-md-6 column">
                                    <span class="badge category-tag" data-category-id="{{ post.category.id }}">{{ post.category.name }}</span>
                                </div>
                                <div class="col-md-6 column text-secondary comments-num">
                                    <p>
                                        <i class="bi bi-chat-right-heart-fill"></i> 
                                        {{ post.comments.all()|length }}
                                    </p>
                                </div>
                            </div>
                            <div class="text-danger mt-5" style="text-align: right;">
                                <button class="btn deleteBtn" id="deletepostbtn22" data-post-id="{{ post.id }}">
                                    <i class="bi bi-trash-fill"></i>
                                    &nbsp;
                                </button>
                            </div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="row clearfix">
                <div class="col-md-12 column">
                    <h5 class="text-center mt-4 text-secondary">
                        This user hasn't posted yet.
                    </h5>
                </div>
            </div>
            {% endif %}
        </div>
                
     <!-- ending -->
 <!-- post list explanation
List of Variables and Their Descriptions
#posts:
Type: List of dictionaries or objects
Description: This should be a list where each element represents a post. Each post contains details such as the title, user information, content, and interactions like replies and likes.
Each post dictionary/object in the posts list should include the following keys/attributes:

1.title:
Type: String
Description: The title of the post.
2.user:
Type: Dictionary/Object
Description: Contains user-specific information. This dictionary/object should include:
2.1 name: The name of the user who posted.
2.2 profile_picture_url: URL to the user's profile picture.
3.time_since_posted:
Type: String
Description: Describes how long ago the post was made (e.g., "an hour ago").
4.edited:
Type: Boolean
Description: Indicates whether the post has been edited.
5.subtitle:
Type: String
Description: A subtitle or secondary title for the post.
6.content:
Type: String
Description: The main content of the post.
7.last_reply:
Type: Dictionary/Object
Description: Contains information about the last reply to the post. It should include:
7.1 user: Dictionary/Object with details of the user who made the last reply.
7.2 name: Name of the user who replied.
8.likes:
Type: Integer
Description: The number of likes the post has received.-->
    </div>
</div>


{% endblock %}


{% block script %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for post in posts %}
            var timestamp_{{ post.id }} = '{{ post.timestamp }}';
            var momentTimestamp_{{ post.id }} = moment(timestamp_{{ post.id }});
            var now = moment();
            var diffInHours_{{ post.id }} = now.diff(momentTimestamp_{{ post.id }}, 'hours');
            var element_{{ post.id }} = document.getElementById('humanTimestamp_{{ post.id }}');

            if (diffInHours_{{ post.id }} < 24) {
                element_{{ post.id }}.textContent = momentTimestamp_{{ post.id }}.fromNow();
            } else {
                element_{{ post.id }}.textContent = momentTimestamp_{{ post.id }}.format('YYYY-MM-DD HH:mm:ss');
            }
        {% endfor %}
    });

    // delete post
    $(document).ready(function () {
        $('#deletepostbtn22').click(function () {
            const post_id = $(this).data('post-id');
            console.log(post_id);
            const baseUrl = `${window.location.protocol}//${window.location.host}`;

            $.ajax({
                type: 'POST',
                url: `${baseUrl}/delete-post/${post_id}`,
                success: function (response) {
                    if (response.code === 200) {
                        $('#resultMessage').html('<div class="alert alert-success" role="alert">Post deleted successfully!</div>');
                        // go to the discussion page
                        setTimeout(function () {
                            window.location.href = window.location.pathname;
                        }, 1000);

                    } else {
                        $('#resultMessage').html('<div class="alert alert-danger" role="alert">Error: ' + response.message + '</div>');
                    }
                },
                error: function () {
                    $('#resultMessage').html('<div class="alert alert-danger" role="alert">An error occurred. Please try again later.</div>');
                }
            });
        });
    });
</script>
{% endblock %}